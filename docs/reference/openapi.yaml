openapi: 3.0.3

info:
  title: Momentum Trading Assistant API
  version: 1.8.0
  description: |
    SUPPORTING REFERENCE FILE (MANUALLY MAINTAINED)

    This OpenAPI specification is a supporting reference representation of the API.
    Canonical API contract truth lives in:
      - docs/specs/api_contracts/

    If this file disagrees with the canonical Markdown API contracts,
    the Markdown contracts take precedence.

    Versioning:
    - This file's version matches the canonical API contract version documented in:
      docs/specs/api_contracts/README.md

    Key principles:
    - Decision-support tool with deterministic server-side logic
    - Backend is single source of truth for calculations
    - Exit prices are user-provided (broker executions)
    - Multi-currency support (GBP base; USD/GBP native values where applicable)

servers:
  - url: https://api.example.com
    description: Production server
  - url: http://localhost:8000
    description: Development server

tags:
  - name: Portfolio
    description: Portfolio management and overview
  - name: Positions
    description: Position entry, exit, and monitoring
  - name: Trades
    description: Trade history and statistics
  - name: Cash
    description: Cash management and transactions
  - name: Signals
    description: Momentum signal generation
  - name: Analytics
    description: Portfolio analytics and validation
  - name: Market
    description: Market regime and status
  - name: Health
    description: System health and diagnostics
  - name: Settings
    description: Strategy configuration
  - name: Journal
    description: Trade journaling and notes

paths:
  /portfolio:
    get:
      tags: [Portfolio]
      summary: Get portfolio overview
      description: |
        Returns complete portfolio overview with live prices, cash balance,
        and open positions.
      responses:
        "200":
          $ref: "#/components/responses/OkPortfolioOverview"
        "500":
          $ref: "#/components/responses/InternalError"

  /portfolio/position:
    post:
      tags: [Portfolio]
      summary: Add a new position
      description: |
        Manual position entry supporting fractional shares.
        Auto-calculates fees, ATR, and initial stops if not provided.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddPositionRequest"
            example:
              ticker: NVDA
              market: US
              entry_date: "2026-02-15"
              shares: 10.5
              entry_price: 850.0
              fx_rate: 1.3642
              atr_value: 15.32
              entry_note: "Breakout above $800 resistance"
              tags: ["momentum", "breakout"]
      responses:
        "200":
          $ref: "#/components/responses/OkAddPosition"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /portfolio/size:
    post:
      tags: [Portfolio]
      summary: Calculate position size
      description: |
        Calculate suggested share quantity for a prospective new position.
        Returns sizing result, risk amount, estimated cost, and cash feasibility.
        Idempotent for same inputs. Does not mutate any state.
        All calculations are authoritative and performed server-side.
        Canonical rules: docs/specs/strategy_rules.md §4.1
        Canonical contract: docs/specs/api_contracts/portfolio_endpoints.md
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SizePositionRequest"
            example:
              entry_price: 850.00
              stop_price: 780.00
              risk_percent: 1.00
              market: US
              fx_rate: 1.3642
      responses:
        "200":
          $ref: "#/components/responses/OkPositionSize"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /portfolio/snapshot:
    post:
      tags: [Portfolio]
      summary: Create daily portfolio snapshot
      description: |
        Idempotent endpoint to create or update the daily snapshot.
        Used for historical tracking and analytics.
      responses:
        "200":
          $ref: "#/components/responses/OkPortfolioSnapshot"
        "500":
          $ref: "#/components/responses/InternalError"

  /portfolio/history:
    get:
      tags: [Portfolio]
      summary: Get portfolio history
      description: Retrieve historical portfolio snapshots for charting.
      parameters:
        - in: query
          name: days
          schema:
            type: integer
            default: 30
            minimum: 1
          description: Number of days to retrieve
      responses:
        "200":
          $ref: "#/components/responses/OkPortfolioHistory"
        "500":
          $ref: "#/components/responses/InternalError"

  /positions:
    get:
      tags: [Positions]
      summary: Get all open positions
      description: |
        Returns open positions with live prices, stops, and P&L.
        Fetches refreshed market pricing on every call.
      responses:
        "200":
          $ref: "#/components/responses/OkPositions"
        "500":
          $ref: "#/components/responses/InternalError"

  /positions/analyze:
    get:
      tags: [Positions]
      summary: Run daily position analysis
      description: |
        Deterministic daily monitoring:
        - Updates all prices
        - Recalculates stops
        - Checks market regime
        - Recommends HOLD/EXIT actions
      responses:
        "200":
          $ref: "#/components/responses/OkPositionAnalysis"
        "500":
          $ref: "#/components/responses/InternalError"

  /positions/{position_id}/exit:
    post:
      tags: [Positions]
      summary: Exit a position
      description: |
        Exit full or partial position using user-provided prices.
        Records in trade history and updates cash.
      parameters:
        - in: path
          name: position_id
          required: true
          schema:
            type: string
            format: uuid
          description: Position UUID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExitPositionRequest"
            example:
              shares: 10.5
              exit_price: 920.0
              exit_date: "2026-02-15"
              exit_reason: "Target Reached"
              exit_fx_rate: 1.365
              exit_note: "Hit target, took profits"
      responses:
        "200":
          $ref: "#/components/responses/OkExitPosition"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /positions/{position_id}/note:
    patch:
      tags: [Journal]
      summary: Update position notes
      description: |
        Update entry and/or exit notes for a position.
        Pass null to clear a note.
      parameters:
        - in: path
          name: position_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateNoteRequest"
            examples:
              updateEntry:
                value:
                  entry_note: "Updated reasoning after analysis"
                  exit_note: null
              updateBoth:
                value:
                  entry_note: "Breakout confirmed"
                  exit_note: "Target reached"
      responses:
        "200":
          $ref: "#/components/responses/OkUpdateNote"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /positions/{position_id}/tags:
    patch:
      tags: [Journal]
      summary: Update position tags
      description: |
        Replace the full tag set for a position.
        Tags: lowercase, numbers, hyphens only. Max 20 chars each, max 10 tags.
      parameters:
        - in: path
          name: position_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateTagsRequest"
            examples:
              addTags:
                value:
                  tags: ["momentum", "breakout", "winner"]
              clearTags:
                value:
                  tags: []
      responses:
        "200":
          $ref: "#/components/responses/OkUpdateTags"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /positions/tags:
    get:
      tags: [Journal]
      summary: Get all unique tags
      description: |
        Retrieve all tags used across positions for autocomplete.
        Returns sorted alphabetically.
      responses:
        "200":
          $ref: "#/components/responses/OkTagsList"
        "500":
          $ref: "#/components/responses/InternalError"

  /trades:
    get:
      tags: [Trades]
      summary: Get trade history
      description: Retrieve all closed trades with statistics.
      responses:
        "200":
          $ref: "#/components/responses/OkTrades"
        "500":
          $ref: "#/components/responses/InternalError"

  /cash/transaction:
    post:
      tags: [Cash]
      summary: Record cash transaction
      description: Record deposit or withdrawal for accurate P&L.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CashTransactionRequest"
      responses:
        "200":
          $ref: "#/components/responses/OkCashTransaction"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /cash/transactions:
    get:
      tags: [Cash]
      summary: List cash transactions
      parameters:
        - in: query
          name: order
          schema:
            type: string
            enum: [ASC, DESC]
            default: DESC
      responses:
        "200":
          $ref: "#/components/responses/OkCashTransactions"
        "500":
          $ref: "#/components/responses/InternalError"

  /cash/summary:
    get:
      tags: [Cash]
      summary: Get cash flow summary
      responses:
        "200":
          $ref: "#/components/responses/OkCashSummary"
        "500":
          $ref: "#/components/responses/InternalError"

  /signals/generate:
    post:
      tags: [Signals]
      summary: Generate momentum signals
      parameters:
        - in: query
          name: lookback_days
          schema:
            type: integer
            default: 252
            minimum: 1
        - in: query
          name: top_n
          schema:
            type: integer
            default: 5
            minimum: 1
      responses:
        "200":
          $ref: "#/components/responses/OkSignalsGenerate"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /signals:
    get:
      tags: [Signals]
      summary: List signals
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [new, entered, dismissed, expired, already_held]
      responses:
        "200":
          $ref: "#/components/responses/OkSignalsList"
        "500":
          $ref: "#/components/responses/InternalError"

  /signals/{signal_id}:
    patch:
      tags: [Signals]
      summary: Update signal status
      parameters:
        - in: path
          name: signal_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [entered, dismissed, expired]
      responses:
        "200":
          $ref: "#/components/responses/OkSignal"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

    delete:
      tags: [Signals]
      summary: Delete signal
      description: |
        Hard delete a signal record. Non-idempotent:
        a second call returns 404.
      parameters:
        - in: path
          name: signal_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          $ref: "#/components/responses/OkDelete"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /analytics/metrics:
    get:
      tags: [Analytics]
      summary: Get analytics metrics
      description: |
        Unified analytics endpoint returning all analytics data for a given period.
        All monetary values in analytics are GBP.
        When insufficient data exists (total_trades < min_required), the API returns 200
        with has_enough_data=false and empty metric objects.
      parameters:
        - in: query
          name: period
          required: false
          schema:
            type: string
            enum: [all_time, last_7_days, last_month, last_quarter, last_year, ytd]
            default: all_time
      responses:
        "200":
          $ref: "#/components/responses/OkAnalyticsMetrics"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /validate/calculations:
    post:
      tags: [Analytics]
      summary: Validate analytics calculations
      description: |
        Smoke-tests analytics calculations against a fixed internal test dataset.
        Does not write to business data.
      responses:
        "200":
          $ref: "#/components/responses/OkValidation"
        "500":
          $ref: "#/components/responses/InternalError"

  /market/status:
    get:
      tags: [Market]
      summary: Get market regime status
      description: |
        NOTE: This endpoint exists in the implementation but does not yet have a
        canonical Markdown contract in docs/specs/api_contracts/. The canonical
        market regime data is currently surfaced inline via GET /positions/analyze.
        A dedicated market_endpoints.md should be created to formally contract
        this endpoint. Until then, this path is documented here for reference only.
      responses:
        "200":
          $ref: "#/components/responses/OkMarketStatus"
        "500":
          $ref: "#/components/responses/InternalError"

  /health:
    get:
      tags: [Health]
      summary: Basic health check
      description: |
        Health endpoints are an explicit exception to the standard {status,data} response envelope.
      responses:
        "200":
          description: System healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /health/detailed:
    get:
      tags: [Health]
      summary: Detailed health check
      description: |
        Health endpoints are an explicit exception to the standard {status,data} response envelope.
      responses:
        "200":
          description: Detailed health status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthDetailedResponse"

  /test/endpoints:
    post:
      tags: [Health]
      summary: Test all endpoints
      description: |
        Runs endpoint smoke tests. Does not mutate production data.
        Health endpoints are an explicit exception to the standard {status,data} response envelope.
      responses:
        "200":
          description: Tests complete
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EndpointTestResponse"

  /settings:
    get:
      tags: [Settings]
      summary: Get strategy settings
      description: |
        Returns the global settings object as a single-element array.
      responses:
        "200":
          $ref: "#/components/responses/OkSettings"
        "500":
          $ref: "#/components/responses/InternalError"

    put:
      tags: [Settings]
      summary: Update strategy settings
      description: |
        Updates one or more settings fields.
        Fields not provided remain unchanged.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSettingsRequest"
      responses:
        "200":
          $ref: "#/components/responses/OkUpdateSettings"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  schemas:
    ApiOk:
      type: object
      required: [status, data]
      properties:
        status:
          type: string
          enum: [ok]
        data:
          description: Payload varies by endpoint.
          type: object

    ApiError:
      type: object
      required: [status, message]
      properties:
        status:
          type: string
          enum: [error]
        message:
          type: string

    PortfolioOverview:
      type: object
      properties:
        cash: { type: number }
        cash_balance: { type: number }
        total_value: { type: number }
        open_positions_value: { type: number }
        total_pnl: { type: number }
        initial_value: { type: number }
        net_deposits: { type: number }
        live_fx_rate: { type: number }
        last_updated: { type: string, format: date-time }
        positions:
          type: array
          items: { $ref: "#/components/schemas/PositionSummary" }

    PositionSummary:
      type: object
      properties:
        id: { type: string, format: uuid }
        ticker: { type: string }
        market: { type: string, enum: [US, UK] }
        entry_date: { type: string, format: date }
        entry_price: { type: number }
        shares: { type: number }
        current_price: { type: number }
        current_price_native: { type: number }
        stop_price: { type: number }
        stop_price_native: { type: number }
        pnl: { type: number }
        pnl_percent: { type: number }
        holding_days: { type: integer }
        status: { type: string, enum: [open, closed] }
        grace_period: { type: boolean }
        display_status: { type: string, enum: [GRACE, PROFITABLE, LOSING] }

    Position:
      allOf:
        - $ref: "#/components/schemas/PositionSummary"
        - type: object
          properties:
            initial_stop: { type: number }
            atr_value: { type: number }
            fx_rate: { type: number }
            live_fx_rate: { type: number }
            entry_note: { type: string, nullable: true }
            exit_note: { type: string, nullable: true }
            tags:
              type: array
              items: { type: string }

    PortfolioSnapshot:
      type: object
      properties:
        id: { type: string, format: uuid }
        snapshot_date: { type: string, format: date }
        total_value: { type: number }
        cash_balance: { type: number }
        positions_value: { type: number }
        total_pnl: { type: number }
        position_count: { type: integer }
        created_at: { type: string, format: date-time }

    AddPositionRequest:
      type: object
      required: [ticker, entry_date, shares, entry_price]
      properties:
        ticker: { type: string, maxLength: 20 }
        market: { type: string, enum: [US, UK] }
        entry_date: { type: string, format: date }
        shares: { type: number, minimum: 0.0001 }
        entry_price: { type: number, minimum: 0.01 }
        fx_rate: { type: number, nullable: true }
        atr_value: { type: number, nullable: true }
        stop_price: { type: number, nullable: true }
        entry_note: { type: string, maxLength: 500, nullable: true }
        tags:
          type: array
          maxItems: 10
          items:
            type: string
            maxLength: 20
            pattern: "^[a-z0-9-]+$"

    AddPositionResponse:
      type: object
      properties:
        ticker: { type: string }
        total_cost: { type: number }
        fees_paid: { type: number }
        entry_price: { type: number }
        initial_stop: { type: number }
        remaining_cash: { type: number }
        position_id: { type: string, format: uuid }

    SizePositionRequest:
      type: object
      required: [entry_price, stop_price, risk_percent]
      properties:
        entry_price:
          type: number
          minimum: 0.0001
          description: Prospective entry price in instrument's native currency (GBP for UK, USD for US)
        stop_price:
          type: number
          minimum: 0.0001
          description: Intended initial stop price in instrument's native currency
        risk_percent:
          type: number
          minimum: 0.0001
          description: Percentage of portfolio value to risk, e.g. 1.00 for 1%
        market:
          type: string
          enum: [US, UK]
          default: UK
          description: Used for fee estimation in cash feasibility gate
        fx_rate:
          type: number
          minimum: 0.0001
          description: User-provided FX rate override for US positions. Omit to use live system rate.

    PositionSizeResponse:
      type: object
      description: |
        Sizing result. Three distinct shapes depending on outcome:
        - valid: true, cash_sufficient: true — full valid result with suggested_shares auto-filled
        - valid: true, cash_sufficient: false — valid result with max_affordable_shares (always present)
        - valid: false — invalid inputs with reason code
        Canonical field definitions: docs/specs/api_contracts/portfolio_endpoints.md
        Canonical rules: docs/specs/strategy_rules.md §4.1
      properties:
        valid:
          type: boolean
          description: true if inputs satisfy all validity rules in strategy_rules.md §4.1.4
        suggested_shares:
          type: number
          description: Share quantity floored to 4dp. Present only when valid is true.
        risk_amount:
          type: number
          description: PortfolioValue × RiskPercent in GBP. Present when valid is true.
        stop_distance:
          type: number
          description: EntryPrice − StopPrice in native currency. Present when valid is true.
        estimated_cost:
          type: number
          description: SuggestedShares × EntryPrice + EstimatedFees in GBP. Present when valid is true.
        estimated_fees:
          type: number
          description: Fee estimate using current settings parameters. Present when valid is true.
        fx_rate_used:
          type: number
          description: FX rate applied. Always returned when valid is true. 1.0 for UK positions.
        cash_sufficient:
          type: boolean
          description: true if estimated_cost <= available_cash. Present when valid is true.
        available_cash:
          type: number
          description: Current portfolios.cash in GBP. Present when valid is true.
        max_affordable_shares:
          type: number
          description: Always present when cash_sufficient is false. Maximum affordable share quantity floored to 4dp.
        reason:
          type: string
          enum:
            - INVALID_RISK_PERCENT
            - INVALID_ENTRY_PRICE
            - INVALID_STOP_PRICE
            - INVALID_STOP_DISTANCE
            - NO_PORTFOLIO_VALUE_SNAPSHOT
          description: Machine-readable reason code. Present only when valid is false.
        reason_detail:
          type: string
          description: |
            Human-readable description for development and logging use only.
            Must NOT be used as user-facing display text.
            Present only when valid is false.

    ExitPositionRequest:
      type: object
      required: [exit_price]
      properties:
        shares: { type: number, nullable: true }
        exit_price: { type: number, minimum: 0.01 }
        exit_date: { type: string, format: date, nullable: true }
        exit_reason:
          type: string
          enum:
            - Manual Exit
            - Stop Loss Hit
            - Target Reached
            - Risk-Off Signal
            - Trailing Stop
            - Partial Profit Taking
        exit_fx_rate: { type: number, nullable: true }
        exit_note: { type: string, maxLength: 500, nullable: true }

    ExitPositionResponse:
      type: object
      properties:
        ticker: { type: string }
        market: { type: string, enum: [US, UK] }
        exit_price: { type: number }
        shares: { type: number }
        gross_proceeds: { type: number }
        exit_fees: { type: number }
        fee_breakdown:
          type: object
          additionalProperties: true
        net_proceeds: { type: number }
        realized_pnl: { type: number }
        realized_pnl_pct: { type: number }
        new_cash_balance: { type: number }
        exit_fx_rate: { type: number, nullable: true }
        exit_date: { type: string, format: date }
        is_partial_exit: { type: boolean }
        remaining_shares: { type: number }

    UpdateNoteRequest:
      type: object
      minProperties: 1
      properties:
        entry_note: { type: string, maxLength: 500, nullable: true }
        exit_note: { type: string, maxLength: 500, nullable: true }

    UpdateNoteResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        ticker: { type: string }
        entry_note: { type: string, nullable: true }
        exit_note: { type: string, nullable: true }
        updated_at: { type: string, format: date-time }

    UpdateTagsRequest:
      type: object
      required: [tags]
      properties:
        tags:
          type: array
          maxItems: 10
          items:
            type: string
            maxLength: 20
            pattern: "^[a-z0-9-]+$"

    UpdateTagsResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        ticker: { type: string }
        tags:
          type: array
          items: { type: string }
        updated_at: { type: string, format: date-time }

    TagsListResponse:
      type: object
      properties:
        tags:
          type: array
          items: { type: string }
        total_positions: { type: integer }
        positions_with_tags: { type: integer }

    TradeHistoryResponse:
      type: object
      properties:
        total_trades: { type: integer }
        win_rate: { type: number }
        total_pnl: { type: number }
        trades:
          type: array
          items: { $ref: "#/components/schemas/Trade" }

    Trade:
      type: object
      properties:
        id: { type: string, format: uuid }
        ticker: { type: string }
        market: { type: string, enum: [US, UK] }
        entry_date: { type: string, format: date }
        exit_date: { type: string, format: date }
        shares: { type: number }
        entry_price: { type: number }
        exit_price: { type: number }
        pnl: { type: number }
        pnl_pct: { type: number }
        pnl_percent:
          type: number
          description: Duplicate of pnl_pct for compatibility
        holding_days: { type: integer }
        exit_reason: { type: string, nullable: true }
        entry_note: { type: string, nullable: true }
        exit_note: { type: string, nullable: true }
        tags:
          type: array
          items: { type: string }

    CashTransactionRequest:
      type: object
      required: [type, amount]
      properties:
        type: { type: string, enum: [deposit, withdrawal] }
        amount: { type: number, minimum: 0.01 }
        date: { type: string, format: date, nullable: true }
        note: { type: string, maxLength: 200, nullable: true }

    CashTransaction:
      type: object
      properties:
        id: { type: string, format: uuid }
        type: { type: string, enum: [deposit, withdrawal] }
        amount: { type: number }
        date: { type: string, format: date }
        note: { type: string, nullable: true }
        created_at: { type: string, format: date-time }

    CashTransactionResponse:
      type: object
      properties:
        transaction: { $ref: "#/components/schemas/CashTransaction" }
        new_balance: { type: number }

    CashSummary:
      type: object
      properties:
        total_deposits: { type: number }
        total_withdrawals: { type: number }
        net_cash_flow: { type: number }
        current_cash: { type: number }

    Signal:
      type: object
      description: |
        Signal object. suggested_shares is always an integer (whole shares only).
        Fractional share sizing is not supported in signal generation.
        See docs/specs/api_contracts/signal_endpoints.md and data_model.md Section 7.
      properties:
        id: { type: string, format: uuid }
        ticker: { type: string }
        market: { type: string }
        rank: { type: integer }
        momentum_percent: { type: number }
        current_price: { type: number }
        price_gbp: { type: number }
        atr_value: { type: number }
        volatility: { type: number }
        initial_stop: { type: number }
        status: { type: string }
        allocation_gbp: { type: number }
        suggested_shares: { type: integer }   # Always integer — fractional not supported in signal generation
        total_cost: { type: number }
        signal_date: { type: string, format: date }
        created_at: { type: string, format: date-time }

    AnalyticsMetricsResponse:
      type: object
      description: |
        Unified analytics payload.
        Intentionally broad to avoid drift. Canonical nested field definitions live in:
        docs/specs/api_contracts/analytics_endpoints.md
      additionalProperties: true

    ValidationResponse:
      type: object
      description: |
        Validation payload.
        Intentionally broad to avoid drift. Canonical nested field definitions live in:
        docs/specs/api_contracts/analytics_endpoints.md
      additionalProperties: true

    Settings:
      type: object
      description: |
        Settings object. Canonical field meanings and constraints live in:
        docs/specs/api_contracts/settings_endpoints.md
        Includes default_risk_percent (float, > 0, <= 100) added in v1.8.0
        for Position Sizing Calculator pre-population support.
      additionalProperties: true

    UpdateSettingsRequest:
      type: object
      description: |
        All fields optional. Only provided fields are updated.
        Canonical field meanings and constraints live in:
        docs/specs/api_contracts/settings_endpoints.md
        Includes default_risk_percent (float, > 0, <= 100) added in v1.8.0.
      additionalProperties: true

    MarketStatus:
      type: object
      description: |
        Market status payload. No dedicated canonical Markdown contract exists yet.
        Market regime data is currently surfaced inline via GET /positions/analyze.
        See docs/specs/api_contracts/position_endpoints.md for the analyze response shape.
      additionalProperties: true

    HealthResponse:
      type: object
      required: [status, timestamp, version]
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        version:
          type: string

    HealthDetailedResponse:
      allOf:
        - $ref: "#/components/schemas/HealthResponse"
        - type: object
          properties:
            response_time_ms: { type: number }
            checks:
              type: object
              additionalProperties: true

    EndpointTestResponse:
      type: object
      description: |
        Endpoint test results payload.
        Canonical structure lives in:
        docs/specs/api_contracts/health_endpoints.md
      additionalProperties: true

  securitySchemes:
    ApiKey:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication (future use)

  responses:
    BadRequest:
      description: Validation error or business rule violation
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiError"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiError"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiError"

    OkPortfolioOverview:
      description: Portfolio overview retrieved successfully
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/PortfolioOverview"

    OkAddPosition:
      description: Position created successfully
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/AddPositionResponse"

    OkPositionSize:
      description: Position size calculated
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/PositionSizeResponse"

    OkPortfolioSnapshot:
      description: Snapshot created/updated
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/PortfolioSnapshot"

    OkPortfolioHistory:
      description: Portfolio history retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/PortfolioSnapshot"

    OkPositions:
      description: Positions retrieved successfully
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Position"

    OkPositionAnalysis:
      description: Analysis complete
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiOk"

    OkExitPosition:
      description: Exit successful
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/ExitPositionResponse"

    OkUpdateNote:
      description: Notes updated
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/UpdateNoteResponse"

    OkUpdateTags:
      description: Tags updated
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/UpdateTagsResponse"

    OkTagsList:
      description: Tags retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/TagsListResponse"

    OkTrades:
      description: Trade history retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/TradeHistoryResponse"

    OkCashTransaction:
      description: Transaction recorded
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/CashTransactionResponse"

    OkCashTransactions:
      description: Transactions retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/CashTransaction"

    OkCashSummary:
      description: Summary retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/CashSummary"

    OkSignalsGenerate:
      description: Signals generated
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiOk"

    OkSignalsList:
      description: Signals retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Signal"

    OkSignal:
      description: Signal updated
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Signal"

    OkDelete:
      description: Deleted
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    type: object
                    required: [deleted, id]
                    properties:
                      deleted: { type: boolean, enum: [true] }
                      id: { type: string, format: uuid }

    OkAnalyticsMetrics:
      description: Analytics metrics retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/AnalyticsMetricsResponse"

    OkValidation:
      description: Validation complete
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/ValidationResponse"

    OkMarketStatus:
      description: Market status retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/MarketStatus"

    OkSettings:
      description: Settings retrieved
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Settings"

    OkUpdateSettings:
      description: Settings updated
      content:
        application/json:
          schema:
            allOf:
              - $ref: "#/components/schemas/ApiOk"
              - type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Settings"

security:
  - ApiKey: []
