openapi: 3.0.3
info:
  title: Momentum Trading Assistant API
  description: |
    API for the Momentum Trading Assistant web application.
    Decision-support tool only (not a trading bot).  
    Strategy logic is deterministic and server-side.
  version: 1.2.0

servers:
  - url: https://api.example.com
    description: Production server (placeholder)

paths:
  /dashboard:
    get:
      summary: Get daily portfolio dashboard snapshot
      responses:
        "200":
          description: Dashboard snapshot
          content:
            application/json:
              schema:
                type: object
                properties:
                  portfolio_value:
                    type: number
                    format: float
                  cash:
                    type: number
                    format: float
                  cash_pct:
                    type: number
                    format: float
                  positions_value:
                    type: number
                    format: float
                  open_positions:
                    type: integer
                  exit_alerts:
                    type: integer
                  market_status:
                    type: object
                    properties:
                      date:
                        type: string
                        format: date
                      spy:
                        type: object
                        properties:
                          risk_on:
                            type: boolean
                          price:
                            type: number
                            format: float
                          ma200:
                            type: number
                            format: float
                      ftse:
                        type: object
                        properties:
                          risk_on:
                            type: boolean
                          price:
                            type: number
                            format: float
                          ma200:
                            type: number
                            format: float

  /portfolio:
    get:
      summary: Get portfolio overview
      responses:
        "200":
          description: Portfolio overview
          content:
            application/json:
              schema:
                type: object
                properties:
                  cash:
                    type: number
                    format: float
                  last_updated:
                    type: string
                    format: date-time
                  positions:
                    type: array
                    items:
                      type: object
                      properties:
                        ticker:
                          type: string
                        market:
                          type: string
                        entry_date:
                          type: string
                          format: date
                        entry_price:
                          type: number
                          format: float
                        shares:
                          type: number
                        current_price:
                          type: number
                          format: float
                        current_value:
                          type: number
                          format: float
                        pnl:
                          type: number
                          format: float
                        pnl_pct:
                          type: number
                          format: float
                        current_stop:
                          type: number
                          format: float
                        holding_days:
                          type: integer
                        status:
                          type: string
                          enum: [GRACE, PROFITABLE, LOSING, EXIT]

  /portfolio/position:
    post:
      summary: Add a new position (manual entry)
      description: |
        Create a new position with automatic fee calculation,
        ATR calculation, and initial stop setting.
        Supports fractional shares.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ticker:
                  type: string
                  description: Stock symbol (e.g., 'NVDA', 'FRES')
                  example: "NVDA"
                market:
                  type: string
                  enum: [US, UK]
                  description: Market (auto-detected from ticker if not provided)
                  example: "US"
                entry_date:
                  type: string
                  format: date
                  description: Entry date (YYYY-MM-DD)
                  example: "2026-02-07"
                shares:
                  type: number
                  format: float
                  description: Number of shares (fractional supported)
                  example: 5.5
                entry_price:
                  type: number
                  format: float
                  description: Entry price in native currency (USD for US, GBP for UK)
                  example: 243.00
                fx_rate:
                  type: number
                  format: float
                  nullable: true
                  description: GBP/USD rate (auto-fetched if not provided for US stocks)
                  example: 1.3528
                atr_value:
                  type: number
                  format: float
                  nullable: true
                  description: ATR value (auto-calculated from Yahoo Finance if not provided)
                  example: 18.26
                stop_price:
                  type: number
                  format: float
                  nullable: true
                  description: Custom stop (optional, auto-calculated as entry_price - 5×ATR if not provided)
              required:
                - ticker
                - entry_date
                - shares
                - entry_price
      responses:
        "200":
          description: Position created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  data:
                    type: object
                    properties:
                      ticker:
                        type: string
                        example: "NVDA"
                      total_cost:
                        type: number
                        format: float
                        description: Total cost including fees (GBP)
                        example: 986.70
                      fees_paid:
                        type: number
                        format: float
                        description: Total fees paid (GBP)
                        example: 1.48
                      entry_price:
                        type: number
                        format: float
                        description: Entry price in native currency
                        example: 243.00
                      initial_stop:
                        type: number
                        format: float
                        description: Initial stop level (entry_price - 5×ATR)
                        example: 151.70
                      remaining_cash:
                        type: number
                        format: float
                        description: Cash remaining after entry (GBP)
                        example: 4013.30
                      position_id:
                        type: string
                        format: uuid
                        example: "f9516f4e-698d-43ec-8dde-c55ef7496657"
        "400":
          description: Validation error (insufficient funds, invalid data, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /positions/{ticker}:
    get:
      summary: Get detailed position information
      parameters:
        - name: ticker
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Position details
          content:
            application/json:
              schema:
                type: object
                properties:
                  ticker:
                    type: string
                  market:
                    type: string
                  entry_date:
                    type: string
                    format: date
                  entry_price:
                    type: number
                    format: float
                  shares:
                    type: number
                    format: float
                  holding_days:
                    type: integer
                  current_price:
                    type: number
                    format: float
                  atr:
                    type: number
                    format: float
                  current_stop:
                    type: number
                    format: float
                  stop_logic:
                    type: object
                    properties:
                      atr_multiplier:
                        type: number
                      reason:
                        type: string
                  pnl:
                    type: number
                    format: float
                  pnl_pct:
                    type: number
                    format: float
                  risk_status:
                    type: string
                    enum: [RISK_ON, RISK_OFF]

  /positions/analyze:
    get:
      summary: Run daily position analysis
      description: |
        Analyzes all open positions, updates stops, checks market regime,
        and recommends HOLD or EXIT actions.
      responses:
        "200":
          description: Analysis results
          content:
            application/json:
              schema:
                type: object
                properties:
                  analysis_date:
                    type: string
                    format: date
                  summary:
                    type: object
                    properties:
                      total_value:
                        type: number
                        format: float
                      total_pnl:
                        type: number
                        format: float
                      exit_count:
                        type: integer
                  actions:
                    type: array
                    items:
                      type: object
                      properties:
                        ticker:
                          type: string
                        action:
                          type: string
                          enum: [HOLD, EXIT]
                        exit_reason:
                          type: string
                          nullable: true
                        entry_price:
                          type: number
                          format: float
                        current_price:
                          type: number
                          format: float
                        shares:
                          type: number
                          format: float
                        pnl:
                          type: number
                          format: float
                        pnl_pct:
                          type: number
                          format: float
                        current_stop:
                          type: number
                          format: float
                        holding_days:
                          type: integer
                        stop_reason:
                          type: string
                          nullable: true

  /positions/{position_id}/exit:
    post:
      summary: Exit a position (full or partial)
      description: |
        Exit a position and record in trade history.
        Supports partial exits and custom exit dates.
        Requires user-provided exit price and FX rate (US stocks only).
      parameters:
        - name: position_id
          in: path
          required: true
          description: UUID of the position to exit
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                shares:
                  type: number
                  format: float
                  nullable: true
                  description: Number of shares to exit (null = all shares)
                  example: 2.5
                exit_price:
                  type: number
                  format: float
                  description: Actual exit price from broker (REQUIRED)
                  example: 242.67
                exit_date:
                  type: string
                  format: date
                  nullable: true
                  description: Exit date (YYYY-MM-DD, null = today)
                  example: "2026-02-07"
                exit_reason:
                  type: string
                  nullable: true
                  enum:
                    - Manual Exit
                    - Stop Loss Hit
                    - Target Reached
                    - Risk-Off Signal
                    - Trailing Stop
                    - Partial Profit Taking
                  description: Reason for exit (default 'Manual Exit')
                  example: "Stop Loss Hit"
                exit_fx_rate:
                  type: number
                  format: float
                  nullable: true
                  description: GBP/USD rate from broker (REQUIRED for US stocks, ignored for UK)
                  example: 1.3611
              required:
                - exit_price
      responses:
        "200":
          description: Exit successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  data:
                    type: object
                    properties:
                      ticker:
                        type: string
                        example: "WDC"
                      market:
                        type: string
                        enum: [US, UK]
                        example: "US"
                      exit_price:
                        type: number
                        format: float
                        example: 242.67
                      shares:
                        type: number
                        format: float
                        example: 5.5
                      gross_proceeds:
                        type: number
                        format: float
                        description: Gross proceeds in GBP
                        example: 980.59
                      exit_fees:
                        type: number
                        format: float
                        description: Total exit fees in GBP
                        example: 1.47
                      fee_breakdown:
                        type: object
                        properties:
                          commission:
                            type: number
                            description: Commission in native currency
                            example: 0
                          stamp_duty:
                            type: number
                            description: Stamp duty (UK only, always 0 on sales)
                            example: 0
                          fx_fee:
                            type: number
                            description: FX fee in native currency (US only)
                            example: 2.00
                      net_proceeds:
                        type: number
                        format: float
                        description: Net proceeds in GBP
                        example: 979.12
                      realized_pnl:
                        type: number
                        format: float
                        description: Realized P&L in GBP
                        example: -10.29
                      realized_pnl_pct:
                        type: number
                        format: float
                        description: Realized P&L percentage
                        example: -1.04
                      new_cash_balance:
                        type: number
                        format: float
                        description: Portfolio cash balance after exit
                        example: 4153.35
                      exit_fx_rate:
                        type: number
                        format: float
                        description: FX rate used for conversion
                        example: 1.3611
                      exit_date:
                        type: string
                        format: date
                        example: "2026-02-07"
                      is_partial_exit:
                        type: boolean
                        description: True if position remains open with reduced shares
                        example: false
                      remaining_shares:
                        type: number
                        format: float
                        description: Shares remaining in position (0 if full exit)
                        example: 0
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                insufficient_shares:
                  value:
                    status: "error"
                    message: "Insufficient shares. Position has 10.5 shares, exit requested 20"
                missing_fx_rate:
                  value:
                    status: "error"
                    message: "FX rate is required for US stock exits. Please provide the GBP/USD rate from your broker statement."
                invalid_price:
                  value:
                    status: "error"
                    message: "Exit price must be greater than 0"
        "404":
          description: Position not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /trades:
    get:
      summary: Get trade history
      responses:
        "200":
          description: Trade history
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_trades:
                    type: integer
                  win_rate:
                    type: number
                    format: float
                  total_pnl:
                    type: number
                    format: float
                  trades:
                    type: array
                    items:
                      type: object
                      properties:
                        ticker:
                          type: string
                        entry_date:
                          type: string
                          format: date
                        exit_date:
                          type: string
                          format: date
                        pnl:
                          type: number
                          format: float
                        pnl_pct:
                          type: number
                          format: float
                        exit_reason:
                          type: string

components:
  schemas:
    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          enum: [error]
        message:
          type: string
