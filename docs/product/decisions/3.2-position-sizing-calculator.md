# Decisions Record — 3.2 Position Sizing Calculator

**Owner:** Product Owner
**Class:** Planning Document (Class 4)
**Status:** Active
**Last Updated:** 2026-02-20
**Feature:** Roadmap item 3.2 — Position Sizing Calculator
**Meeting:** Pre-alignment meeting
**Attendees:** Product Owner, Head of UX & Design, Head of Engineering, Director of Quality, QA Lead, Head of Specs Team, API Contracts & Documentation Owner, Data Model & Domain Schema Owner, Strategy Rules & System Intent Owner, Frontend Specifications & UX Documentation Owner

> **Standing notice:** This document records decisions made during the pre-alignment meeting for roadmap item 3.2. It is not a canonical specification. It exists to provide rationale and traceability for the specification and scope documents that follow. Implementation is complete and verified — Director of Quality sign-off granted 2026-02-20 (v1.2 re-verification pass). When shipping closure is confirmed, this document status will be updated to Superseded with references to the canonical documents it produced.

---

## Decision 1 — Endpoint shape and placement

**Question:** What is the API endpoint for the sizing calculator — its path, HTTP method, request schema, response schema, error codes, and domain placement?

**Decision:**

- Endpoint: `POST /portfolio/size`
- Placed in `portfolio_endpoints.md` — not `position_endpoints.md` — because it is called before a position exists, during entry
- Idempotent for same inputs; no state mutation
- Required request fields: `entry_price`, `stop_price`, `risk_percent`
- Optional request fields: `market` (default `"UK"`), `fx_rate` (user override; system live rate used if omitted)
- Valid response includes: `valid: true`, `suggested_shares` (4dp floored), `risk_amount`, `stop_distance`, `estimated_cost`, `estimated_fees`, `fx_rate_used`, `cash_sufficient`, `available_cash`
- Insufficient cash response adds: `max_affordable_shares` — always present when `cash_sufficient: false`, never optional
- Invalid response: `valid: false`, `reason` (machine-readable code), `reason_detail` (development/logging use only — must not be used as UI display text)
- Reason codes: `INVALID_RISK_PERCENT`, `INVALID_ENTRY_PRICE`, `INVALID_STOP_PRICE`, `INVALID_STOP_DISTANCE`, `NO_PORTFOLIO_VALUE_SNAPSHOT`
- HTTP 400 for malformed requests only; all business rule failures return HTTP 200 with `valid: false`

**Rationale:** Placing the endpoint under `/portfolio/` is consistent with `POST /portfolio/position` — both operate at the portfolio level before a position record exists. The clean separation of HTTP 400 (malformed) vs 200 with `valid: false` (business rule) prevents frontend error handling from conflating two different failure types. `max_affordable_shares` being always-present on `INSUFFICIENT_CASH` eliminates conditional optional field ambiguity for frontend engineers.

**Confirmed by:** API Contracts & Documentation Owner (authored), Head of Engineering (reviewed), Product Owner (approved)

---

## Decision 2 — Calculation trigger

**Question:** Does the widget recalculate on every keystroke, on field blur, or on a button press?

**Decision:** Debounced live calculation. The widget recalculates 300ms after the user stops typing. The frontend owns and implements the debounce. The widget displays a loading state during the window between the debounce firing and the response returning.

**Rationale:** Live calculation on keystroke is the correct user experience for a daily workflow tool. Unbounced keystroke calls would cause unnecessary API load and perceived lag. 300ms debounce produces a live feel while being practical. Engineering confirmed the sizing endpoint is a lightweight synchronous backend operation with no external calls, making the round-trip fast enough that 300ms debounce will feel instant.

**Confirmed by:** Product Owner (intent), Head of UX & Design (experience design), Head of Engineering (technical feasibility)

---

## Decision 3 — Widget placement and auto-fill behaviour

**Question:** Where does the widget sit in the position entry form, and how does the suggested shares value interact with the shares field?

**Decision:**

- Widget sits directly above the shares field, visually connected to it
- If the shares field is empty: auto-fill immediately when a valid result is returned
- If the user has already manually entered a share count: do not overwrite — show the suggested value with an explicit "use this" affordance instead
- The widget is always visible in the form; it is not hidden behind a toggle

**Rationale:** Proximity to the shares field makes the relationship between suggestion and input obvious. Silent overwrite of a manually entered value could cause a user to submit an unintended position size — this is a financial safety consideration. The always-visible approach (replacing the toggle specified in `strategy_rules.md §4.1.7` v1.2) ensures the feature delivers its daily workflow value without requiring users to discover or activate it.

**Note:** This decision supersedes the toggle interaction described in `strategy_rules.md §4.1.7` (v1.2). That section requires a version increment to v1.3. See Action A4.

**Confirmed by:** Product Owner (intent and final approval), Head of UX & Design (experience design), Head of Engineering (no implementation objection)

---

## Decision 4 — Cash constraint presentation

**Question:** When the cash constraint is hit and `INSUFFICIENT_CASH` is returned, how is `MaxAffordableShares` presented to the user?

**Decision:** Shown as a secondary informational line in muted styling beneath the share count result. Text reads: "Maximum affordable: X shares based on available cash." Not styled as a warning or error. Shares field is not auto-filled in this state. The user sees the constraint, understands it, and makes a conscious choice.

**Rationale:** The user may simply be sizing larger than their current cash allows — that is useful information, not a failure. Framing it as an error would create unnecessary alarm and could cause users to reduce their intended position size based on UI tone rather than deliberate choice. Muted informational styling is consistent with the system's decision-support philosophy.

**Confirmed by:** Product Owner (framing intent), Head of UX & Design (visual treatment)

---

## Decision 5 — Default risk percentage

**Question:** Should the widget pre-populate the risk percentage field from settings, and if so does `default_risk_percent` need to be added to the settings schema?

**Decision:** Yes, the widget pre-populates from settings. `default_risk_percent` is in scope for 3.2 — not deferred.

Field specification:
- Type: `DECIMAL(4,2)`
- Constraint: `NOT NULL`
- Default: `1.00`
- Check: `> 0 AND <= 100`

The field represents a pre-population default for the sizing calculator, not an enforced hard limit — the user may override it on any individual trade. This distinction must be reflected in the settings page helper text.

**Rationale:** Requiring the user to type their risk percentage from scratch on every trade entry defeats the daily workflow improvement goal of the feature. A default of 1.00 (1%) is a conservative, sensible starting point consistent with standard risk management practice.

**Scope impact:** This decision expanded the 3.2 effort estimate from 1–2 days to 2–3 days. Additional work: settings table migration, settings endpoint contract update, settings page UI update, and additional spec document updates across four files.

**Confirmed by:** Product Owner (in scope, intent), Head of Specs Team (scoping decision), Data Model & Domain Schema Owner (field spec and migration)

---

## Decision 6 — Invalid state behaviour

**Question:** What does the widget display when the sizing result is invalid — blank, a message, or a raw reason code?

**Decision:**

- User input invalid conditions (stop >= entry, zero/negative values): inline amber message in plain human-readable language beneath the widget output. Example: "Stop price must be below entry price." Amber, not red — these are input states, not errors.
- System condition invalid (`NO_PORTFOLIO_VALUE_SNAPSHOT`): distinct message making clear it is not a user error. Example: "Portfolio value unavailable — cannot calculate position size."
- Raw reason codes are never shown in the UI. The frontend derives its own plain-language messages from the `reason` code in the API response.
- Widget remains visible and editable in all invalid states.
- Form submission is not blocked by invalid sizing widget state — the user can still enter shares manually and proceed.

**Rationale:** Exposing internal reason codes as user-facing text would be confusing. Amber (not red) for input conditions avoids false alarm and correctly characterises these as informational feedback. Not blocking form submission preserves user autonomy — the sizing widget is decision support, not a gate.

**Confirmed by:** Head of UX & Design (authored), Product Owner (approved)

---

## Specs Requiring Updates as a Result of These Decisions

| Document | Change Required | Driven by |
|----------|----------------|-----------|
| `docs/specs/strategy_rules.md §4.1.7` | Replace toggle model with always-visible widget. Version increment 1.2 → 1.3 | Decision 3 |
| `docs/specs/data_model.md` | Add `default_risk_percent` field and v1.7 migration script | Decision 5 |
| `docs/specs/api_contracts/portfolio_endpoints.md` | Add `POST /portfolio/size` endpoint | Decision 1 |
| `docs/specs/api_contracts/settings_endpoints.md` | Add `default_risk_percent` to GET and PUT /settings | Decision 5 |
| `docs/specs/frontend/components/position_form.md` | Add sizing calculator widget section | Decisions 2, 3, 4, 6 |
| `docs/specs/frontend/pages/settings.md` | Add `default_risk_percent` to Strategy Parameters section | Decision 5 |
| `docs/specs/frontend/patterns/api_dependencies.md` | Add `POST /portfolio/size` as Trade Entry Page dependency | Decision 1 |
| `docs/product/roadmap.md` | Update effort estimate to 2–3 days; note expanded scope | Decision 5 |
| `docs/reference/openapi.yaml` | Align with all API contract changes above | Decisions 1, 5 |
