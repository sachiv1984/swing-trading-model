# Decisions Record — 3.2 Position Sizing Calculator

**Owner:** Product Owner
**Class:** Planning Document (Class 4)
**Status:** Superseded
**Last Updated:** 2026-02-21
**Feature:** Roadmap item 3.2 — Position Sizing Calculator
**Superseded by:** `docs/product/changelog.md` — v1.6 entry (shipped 2026-02-20, Director of Quality sign-off)

> **Standing notice:** This document records decisions made during the pre-alignment meeting for roadmap item 3.2. It is not a canonical specification. It exists to provide rationale and traceability for the specification and scope documents that follow.

> **Lifecycle note:** This decisions record is superseded. The feature shipped in v1.6 (Director of Quality sign-off 2026-02-20). Verification report: `docs/product/verification/3.2-position-sizing-calculator-verification.md` (v1.4). For the delivery record, see `docs/product/changelog.md` v1.6 entry. The canonical specifications produced by these decisions remain authoritative and current — refer to Section "Specs Requiring Updates" for the full list.

---

## Meeting Details

**Meeting:** Pre-alignment meeting
**Attendees:** Product Owner, Head of UX & Design, Head of Engineering, Director of Quality, QA Lead, Head of Specs Team, API Contracts & Documentation Owner, Data Model & Domain Schema Owner, Strategy Rules & System Intent Owner, Frontend Specifications & UX Documentation Owner

---

## Decision 1 — Endpoint shape and placement

**Question:** What is the API endpoint for the sizing calculator — its path, HTTP method, request schema, response schema, error codes, and domain placement?

**Decision:**

- Endpoint: `POST /portfolio/size`
- Placed in `portfolio_endpoints.md` — not `position_endpoints.md` — because it is called before a position exists, during entry
- Idempotent for same inputs; no state mutation
- Required request fields: `entry_price`, `stop_price`, `risk_percent`
- Optional request fields: `market` (default `"UK"`), `fx_rate` (user override; system live rate used if omitted)
- Valid response includes: `valid: true`, `suggested_shares` (4dp floored), `risk_amount`, `stop_distance`, `estimated_cost`, `estimated_fees`, `fx_rate_used`, `cash_sufficient`, `available_cash`
- Insufficient cash response adds: `max_affordable_shares` — always present when `cash_sufficient: false`, never optional
- Invalid response: `valid: false`, `reason` (machine-readable code), `reason_detail` (development/logging use only — must not be used as UI display text)
- Reason codes: `INVALID_RISK_PERCENT`, `INVALID_ENTRY_PRICE`, `INVALID_STOP_PRICE`, `INVALID_STOP_DISTANCE`, `NO_PORTFOLIO_VALUE_SNAPSHOT`
- HTTP 400 for malformed requests only; all business rule failures return HTTP 200 with `valid: false`

**Rationale:** Placing the endpoint under `/portfolio/` is consistent with `POST /portfolio/position` — both operate at the portfolio level before a position record exists. The clean separation of HTTP 400 (malformed) vs 200 with `valid: false` (business rule) prevents frontend error handling from conflating two different failure types. `max_affordable_shares` being always-present on `INSUFFICIENT_CASH` eliminates conditional optional field ambiguity for frontend engineers.

**Confirmed by:** Product Owner (in scope, intent), API Contracts & Documentation Owner (contract design), Head of Engineering (implementability)

---

## Decision 2 — Widget placement and visibility model

**Question:** Where does the sizing calculator live in the UI — always visible, toggle, modal, or sidebar?

**Decision:**

- Always-visible widget embedded directly in the Trade Entry form, immediately above the Shares input field
- No toggle, no modal, no sidebar
- Widget is present on form load with no user action required

**Rationale:** A toggle introduces a discovery problem — users who would benefit most may never find it. Always-visible is consistent with the system's philosophy of surfacing decision-relevant information at the point of decision. The widget is small enough that it does not crowd the form.

**Confirmed by:** Product Owner (in scope, intent), Head of UX & Design (placement and interaction)

---

## Decision 3 — Auto-fill behaviour

**Question:** Should the widget auto-fill the Shares field, or only show a suggestion?

**Decision:**

- When the sizing result is valid, `cash_sufficient: true`, and the Shares field is empty: auto-fill Shares with `suggested_shares`
- When the Shares field is already populated by the user: do not overwrite. Instead, show a "Use suggested shares" button
- Clicking "Use suggested shares" updates the Shares field and removes the button
- On form submission: widget resets to idle state; Risk % retains the last-used value

**Rationale:** Auto-filling an empty field removes friction for the common case. Not overwriting an existing value respects user intent and avoids surprising data loss. The explicit affordance keeps the override path discoverable.

**Confirmed by:** Head of UX & Design (authored), Product Owner (approved)

---

## Decision 4 — Debounce and trigger

**Question:** When does the widget call the API — on every keystroke, on blur, or with a debounce?

**Decision:**

- 300ms debounce after the last input change to Entry Price, Stop Price, or Risk %
- API is called automatically — no button press required
- Widget shows a loading state during the API call
- Network failures result in `—` in all output fields; form remains submittable

**Rationale:** 300ms is standard debounce for financial input fields — short enough to feel responsive, long enough to avoid firing on every keystroke. Automatic triggering (no button) is consistent with the always-visible, low-friction philosophy.

**Confirmed by:** Head of UX & Design (authored), Head of Engineering (implementability)

---

## Decision 5 — Default risk percentage and settings integration

**Question:** How is the Risk % field pre-populated, and where is the default stored?

**Decision:**

- A new `default_risk_percent` field is added to the `settings` table
- `GET /settings` returns `default_risk_percent`; `PUT /settings` accepts it
- On Trade Entry form load, the widget reads `settings.default_risk_percent` and pre-populates the Risk % field
- The user can override Risk % per trade without affecting the saved default
- The Settings page exposes `default_risk_percent` in the Strategy Parameters section
- Constraint: > 0 and ≤ 100. Zero or negative values are rejected with HTTP 400. Default value for existing rows: `1.00`

**Rationale:** Pre-population removes the need to re-enter the same risk percentage on every trade. Storing it in settings makes it persistent and user-configurable without introducing a new concept. The constraint prevents obviously invalid inputs (0% or negative risk is not meaningful).

**Confirmed by:** Product Owner (in scope, intent), Head of Specs Team (scoping decision), Data Model & Domain Schema Owner (field spec and migration)

---

## Decision 6 — Invalid state behaviour

**Question:** What does the widget display when the sizing result is invalid — blank, a message, or a raw reason code?

**Decision:**

- User input invalid conditions (stop >= entry, zero/negative values): inline amber message in plain human-readable language beneath the widget output. Example: "Stop price must be below entry price." Amber, not red — these are input states, not errors.
- System condition invalid (`NO_PORTFOLIO_VALUE_SNAPSHOT`): distinct message making clear it is not a user error. Example: "Portfolio value unavailable — cannot calculate position size."
- Raw reason codes are never shown in the UI. The frontend derives its own plain-language messages from the `reason` code in the API response.
- Widget remains visible and editable in all invalid states.
- Form submission is not blocked by invalid sizing widget state — the user can still enter shares manually and proceed.

**Rationale:** Exposing internal reason codes as user-facing text would be confusing. Amber (not red) for input conditions avoids false alarm and correctly characterises these as informational feedback. Not blocking form submission preserves user autonomy — the sizing widget is decision support, not a gate.

**Confirmed by:** Head of UX & Design (authored), Product Owner (approved)

---

## Specs Requiring Updates as a Result of These Decisions

| Document | Change Required | Driven by |
|----------|----------------|-----------|
| `docs/specs/strategy_rules.md §4.1.7` | Replace toggle model with always-visible widget. Version increment 1.2 → 1.3 | Decision 3 |
| `docs/specs/data_model.md` | Add `default_risk_percent` field and v1.7 migration script | Decision 5 |
| `docs/specs/api_contracts/portfolio_endpoints.md` | Add `POST /portfolio/size` endpoint | Decision 1 |
| `docs/specs/api_contracts/settings_endpoints.md` | Add `default_risk_percent` to GET and PUT /settings | Decision 5 |
| `docs/specs/frontend/components/position_form.md` | Add sizing calculator widget section | Decisions 2, 3, 4, 6 |
| `docs/specs/frontend/pages/settings.md` | Add `default_risk_percent` to Strategy Parameters section | Decision 5 |
| `docs/specs/frontend/patterns/api_dependencies.md` | Add `POST /portfolio/size` as Trade Entry Page dependency | Decision 1 |
| `docs/product/roadmap.md` | Update effort estimate to 2–3 days; note expanded scope | Decision 5 |
| `docs/reference/openapi.yaml` | Align with all API contract changes above | Decisions 1, 5 |

All of the above were completed prior to implementation opening. See scope document `docs/product/scope/scope--3.2-position-sizing-calculator.md` for the pre-implementation checklist.