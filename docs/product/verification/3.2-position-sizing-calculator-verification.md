# Verification Report â€” 3.2 Position Sizing Calculator

**Feature:** 3.2 â€” Position Sizing Calculator
**Scope document:** docs/product/scope/Scope 3.2 position sizing calculator.md
**Verified by:** QA Lead
**Verification environment:** https://sachiv1984.github.io/swing-trading-model (Frontend) / https://trading-assistant-api-c0f9.onrender.com (Backend)
**Date started:** 2026-02-19
**Date completed:** 2026-02-19
**Test scenarios:** docs/testing/3.2-position-sizing-calculator-test-scenarios.md

---

## Verdict

**Pass with defects raised â€” re-verification pass complete for DEF-002, DEF-003, DEF-004**

No Critical or High severity defects. DEF-002, DEF-003, DEF-004 resolved and re-verified. DEF-005 closed as not a defect (see notes). DEF-006 (Risk % session persistence) remains open. F15 remains deferred. Director of Quality sign-off previously granted at v1.1 â€” updating report to reflect completed re-verification pass.

**Update history:**
- v1.0 â€” 2026-02-19 â€” Initial report filed. F15â€“F18 deferred, OBS-002 open.
- v1.1 â€” 2026-02-19 â€” F16, F17, F18 executed. OBS-002 resolved to DEF-005. DEF-006 raised. Resubmitted to Director of Quality. Sign-off granted.
- v1.2 â€” 2026-02-20 â€” Re-verification pass complete. DEF-002, DEF-003 closed (F13, F14 pass). DEF-004 closed (F21, F22 pass). DEF-005 closed as not a defect â€” B04 reclassified pass. DEF-006 remains open (Low). F15 still deferred.

---

## Acceptance Criteria Results

### Backend â€” POST /portfolio/size

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| B1 | Valid inputs, sufficient cash â†’ valid: true, cash_sufficient: true, suggested_shares floored to 4dp, all fields present | âœ… Pass | suggested_shares: 2.6517. Calculation verified: floor(53.035/20, 4dp) = 2.6517 âœ…. fx_rate_used: 1.0 |
| B2 | Valid US inputs, explicit fx_rate â†’ fx_rate_used matches input | âœ… Pass | fx_rate_used: 1.35 matches explicit input |
| B3 | Valid US inputs, no fx_rate â†’ system live rate applied | âœ… Pass | fx_rate_used: 1.3459 (live rate, not 1.0) |
| B4 | suggested_shares floored to 4dp (conservative) | âœ… Pass | Response: 5.6003. Initial query raised as DEF-005 â€” resolved as not a defect. `get_latest_snapshot()` returns live mark-to-market `total_value` including open position values priced against live Yahoo Finance prices at call time. Test baseline of Â£5,303.50 was a point-in-time figure that had moved slightly by the time of the API call, producing 5.6003 instead of 5.6013. Calculation is correct and fully traceable given actual portfolio value at call time. DEF-005 closed. Re-verified 2026-02-20. |
| B5 | Repeated calls with same inputs return identical result | âœ… Pass | Both responses identical across all fields |
| B6 | market defaults to UK when omitted | âœ… Pass | fx_rate_used: 1.0 confirmed |
| B7 | Insufficient cash â†’ valid: true, cash_sufficient: false, max_affordable_shares present | âœ… Pass | max_affordable_shares: 1.9936 present and populated |
| B8 | max_affordable_shares present in all three insufficient cash variants | âœ… Pass | Scenario A: 4.9841, Scenario B: 1.1727, Scenario C: 1.9936 â€” all present |
| B9 | risk_percent: 0 â†’ valid: false, reason: INVALID_RISK_PERCENT | âœ… Pass | |
| B10 | risk_percent negative â†’ valid: false, reason: INVALID_RISK_PERCENT | âœ… Pass | |
| B11 | stop_price >= entry_price (equal) â†’ valid: false, reason: INVALID_STOP_DISTANCE | âœ… Pass | |
| B12 | stop_price > entry_price â†’ valid: false, reason: INVALID_STOP_DISTANCE | âœ… Pass | |
| B13 | entry_price: 0 â†’ valid: false, reason: INVALID_ENTRY_PRICE | âœ… Pass | |
| B14 | stop_price: 0 â†’ valid: false, reason: INVALID_STOP_PRICE | âœ… Pass | |
| B15 | No portfolio snapshot â†’ valid: false, reason: NO_PORTFOLIO_VALUE_SNAPSHOT | âœ… Pass | Verified via BEGIN/ROLLBACK transaction |
| B16 | Missing entry_price â†’ HTTP 400 | âœ… Pass | Pydantic missing field error returned |
| B17 | Missing stop_price â†’ HTTP 400 | âœ… Pass | Pydantic missing field error returned |
| B18 | Missing risk_percent â†’ HTTP 400 | âœ… Pass | Pydantic missing field error returned |
| B19 | Invalid market value â†’ HTTP 400 | âœ… Pass | Pydantic value_error for market: "AU" |
| B20 | No state mutation after any call | âœ… Pass | Cash: Â£1,001.82 before and after. Positions: 5 before and after. portfolio_history rows: 16 before and after |

### Backend â€” default_risk_percent

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| B21 | GET /settings includes default_risk_percent | âœ… Pass | Field present, value: 1.0 |
| B22 | PUT rejects default_risk_percent: 0 | âœ… Pass | HTTP 422, Pydantic value_error. Note: spec states HTTP 400 â€” minor spec/implementation drift, Low severity observation |
| B23 | PUT rejects default_risk_percent: -1 | âœ… Pass | HTTP 422, correct constraint message |
| B24 | PUT rejects default_risk_percent: 101 | âœ… Pass | HTTP 422, correct constraint message |
| B25 | PUT 1.5 persists, confirmed by subsequent GET | âœ… Pass | PUT returned 1.5, GET confirmed 1.5. Restored to 1.0 after test |
| B26 | Existing settings rows unaffected by migration | âœ… Pass | All pre-existing fields intact, default_risk_percent: 1.0 |

### Frontend â€” Widget idle and loading states

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| F1 | Widget visible on form load without any user action | âœ… Pass | DEF-001 resolved prior to verification (see Defects section) |
| F2 | Risk % field pre-populated from settings.default_risk_percent | âœ… Pass | |
| F3 | Loading state shown during debounce | âœ… Pass | |
| F4 | No API call when Entry Price or Stop Price empty | âœ… Pass | |

### Frontend â€” Widget valid states and auto-fill

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| F5 | Shares field empty â†’ auto-fills with suggested_shares | âœ… Pass | Shares suggested to 4dp, confirmed correct per spec |
| F6 | Shares field already populated â†’ not overwritten, "Use suggested shares" button appears | âœ… Pass | Button styling unconfirmable against spec (secondary/outline) â€” Low severity observation |
| F7 | Clicking "Use suggested shares" fills Shares and hides button | âœ… Pass | |
| F8 | Risk % change triggers recalculation | âœ… Pass | Existing shares remain stable during recalculation, confirmed correct per spec |

### Frontend â€” Widget insufficient cash state

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| F9 | cash_sufficient: false â†’ informational display, Shares not auto-filled, button not shown | âœ… Pass | Amber estimated cost styling unconfirmable â€” Low severity observation |
| F10 | max_affordable_shares value matches API response | âœ… Pass | Screen value 4.9841 matches TS-B08(A) response |

### Frontend â€” Widget invalid input states

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| F11 | INVALID_STOP_DISTANCE â†’ amber message "Stop price must be below entry price" | âœ… Pass | |
| F12 | INVALID_RISK_PERCENT â†’ amber message "Risk % must be greater than zero" | âœ… Pass | |
| F13 | INVALID_ENTRY_PRICE â†’ amber message shown | âœ… Pass | Amber message "Enter a valid entry price above zero" confirmed. Root cause of original failure: (1) widget `getStatus()` only handled `INVALID_RISK_PERCENT` explicitly â€” fixed by adding `AMBER_MESSAGES` map; (2) parent `TradeEntry.js` passed `parseFloat(entry_price) || null` which coerced `0` to `null` before reaching widget â€” fixed by explicit empty string check. Re-verified 2026-02-20. DEF-002 closed. |
| F14 | INVALID_STOP_PRICE â†’ amber message shown | âœ… Pass | Amber message "Enter a valid stop price above zero" confirmed. Same root causes as DEF-002. Re-verified 2026-02-20. DEF-003 closed. |

### Frontend â€” Widget invalid system state

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| F15 | NO_PORTFOLIO_VALUE_SNAPSHOT â†’ muted grey message | â³ Deferred | Requires database access â€” deferred to re-verification pass |

### Frontend â€” Widget network failure and form submission

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| F16 | Network failure â†’ dashes shown, form submittable | âœ… Pass | Network set to Offline via DevTools. Widget showed `â€”`. Submit button disabled until Shares manually entered â€” correct form validation behaviour, not a widget block. Once Shares entered, Submit enabled. Form submittable confirmed. |
| F17 | Form submits regardless of widget state | âœ… Pass | Widget showing INVALID_STOP_DISTANCE amber message. Shares manually entered, form completed and submitted. Position created and visible on Positions page. Widget state did not block submission. |
| F18 | Post-submit: widget resets, Risk % retains last-used value | âŒ Fail | After submission app navigates to Positions page. On returning to Trade Entry, Risk % reset to settings default `1.00` rather than retaining session value `2.00`. Component unmount on navigation loses in-session override. See DEF-006. |

### Frontend â€” Settings page

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| F19 | default_risk_percent field present in Strategy Parameters section | âœ… Pass | |
| F20 | Helper text exact match | âŒ Known deviation | Observed: "Pre-populates the position sizing calculator". Expected: "Pre-filled in the Position Sizing Calculator on trade entry. This is your default â€” you can override it per trade." Low severity â€” cosmetic only |
| F21 | Saving 0 rejected with error message | âœ… Pass | Red inline error on field: "default_risk_percent must be greater than 0 and at most 100". Error message contains raw field name â€” not fully user-friendly. Logged as Low observation OBS-006. Re-verified 2026-02-20. DEF-004 closed. |
| F22 | Saving negative value rejected with error message | âœ… Pass | Same inline error displayed for -1. Same Low observation on field name. Re-verified 2026-02-20. |
| F23 | Valid value persists and pre-populates widget on next load | âœ… Pass | Saved 2.50, confirmed on Trade Entry load. Restored to 1.00 after test |

### Regression

| # | Area | Result | Notes |
|---|------|--------|-------|
| R1 | Trade Entry form submits without widget interaction | âœ… Pass | Position created successfully without using widget |
| R2 | Existing positions unaffected | âœ… Pass | All pre-existing positions unchanged after full test run |
| R3 | Existing settings unaffected by migration | âœ… Pass | All pre-3.2 fields retain stored values |

---

## Defects Raised

### DEF-001 â€” Widget produces no output (RESOLVED)
- **Severity:** High
- **Status:** âœ… Resolved prior to verification
- **Criterion:** F01
- **Root cause:** `PositionSizingWidget.js` imported `base44` and called `base44.api.post()` which does not exist on the `base44` object. API call silently failed, catch block fired, widget showed nothing.
- **Fix:** Updated import to `api` from `base44Client`. Added `api.portfolio.size()` method to `base44Client.js`. Updated response handling to reflect `doFetch` envelope unwrapping (`response.valid` not `response.data.valid`).
- **Re-verified:** F01â€“F04 all pass post-fix.

### DEF-002 â€” INVALID_ENTRY_PRICE message not rendered (RESOLVED)
- **Severity:** Medium
- **Status:** âœ… Resolved â€” re-verified 2026-02-20
- **Criterion:** F13
- **Observed:** Entry Price set to 0, Stop Price 90.00 â€” widget showed no error message
- **Expected:** Amber message "Enter a valid entry price above zero"
- **Root cause:** Two compounding issues: (1) `PositionSizingWidget.js` `getStatus()` only handled `INVALID_RISK_PERCENT` explicitly in amber handler â€” `INVALID_ENTRY_PRICE` fell through to `SYSTEM_MESSAGES` grey path. Fixed by replacing with `AMBER_MESSAGES` map covering all user input invalid conditions. (2) `TradeEntry.js` passed `parseFloat(formData.entry_price) || null` â€” `parseFloat("0")` returns `0`, and `0 || null` evaluates to `null`, so `0` was converted to `null` before reaching the widget, causing the guard to exit early with no API call. Fixed by explicit empty string check: `formData.entry_price === "" ? null : parseFloat(formData.entry_price)`.

### DEF-003 â€” INVALID_STOP_PRICE message not rendered (RESOLVED)
- **Severity:** Medium
- **Status:** âœ… Resolved â€” re-verified 2026-02-20
- **Criterion:** F14
- **Observed:** Stop Price set to 0, Entry Price 100.00 â€” widget showed no error message
- **Expected:** Amber message "Enter a valid stop price above zero"
- **Root cause:** Same two compounding issues as DEF-002. Fixed in same commits.

### DEF-004 â€” Settings page silently swallows invalid save (RESOLVED)
- **Severity:** Medium
- **Status:** âœ… Resolved â€” re-verified 2026-02-20
- **Criteria:** F21, F22
- **Observed:** Setting default_risk_percent to 0 or negative value â€” save button responded, no error message displayed
- **Expected:** Validation error displayed informing user the save was rejected
- **Root cause:** `saveMutation` in `Settings.js` had no `onError` handler. HTTP 422 response from backend was thrown by `doFetch` but silently swallowed with no user feedback.
- **Fix:** Added `onError` handler to `saveMutation`. Parses Pydantic validation error array from HTTP 422 response, maps each error to its field name, stores in `fieldErrors` state. Field border turns red and inline error message replaces helper text. Toast notification shown. Errors clear on field edit or successful save.
- **Note:** Error message text contains raw Pydantic field name (`default_risk_percent must be greater than 0 and at most 100`) â€” not fully user-friendly. Logged as OBS-006 for cosmetic follow-up.

### DEF-005 â€” suggested_shares calculation not fully traceable (CLOSED â€” NOT A DEFECT)
- **Severity:** Medium
- **Status:** âœ… Closed â€” not a defect. B04 reclassified âœ… Pass.
- **Criterion:** B04
- **Observed:** `suggested_shares: 5.6003` returned for inputs `entry_price: 100, stop_price: 90.53, risk_percent: 1.00`. Manual calculation using test baseline portfolio value of Â£5,303.50 produces 5.6013.
- **Resolution:** The calculation is correct and fully traceable. `get_latest_snapshot()` returns live mark-to-market `total_value` which includes open position values priced against Yahoo Finance at call time. The test baseline of Â£5,303.50 was a point-in-time figure â€” by the time the API call was made, the live portfolio value had moved slightly, producing 5.6003. This is expected and correct behaviour for a live system. No code defect exists.

### DEF-006 â€” Risk % resets to settings default after navigation
- **Severity:** Low
- **Status:** ğŸ”´ Open â€” assigned to Head of Engineering
- **Criterion:** F18
- **Observed:** Risk % set to `2.00` during session. After form submission, app navigates to Positions page. On returning to Trade Entry, Risk % shows `1.00` (settings default) â€” in-session value not retained.
- **Expected:** Risk % retains last-used value within the session per `position_form.md Â§Widget â€” post-submit behaviour`
- **Likely cause:** Widget component unmounts on navigation and remounts from settings default â€” no session persistence of Risk % override
- **Note:** Low severity â€” settings default of `1.00` is a reasonable fallback. User impact is minor (must re-enter preferred Risk % on each visit to Trade Entry). Would require session storage or lifted state to persist across navigation.

---

## Observations

**OBS-001 â€” HTTP 422 vs HTTP 400 for settings constraint violations**
B22â€“B24 returned HTTP 422 (Unprocessable Entity) rather than HTTP 400. This is standard FastAPI/Pydantic behaviour and is consistent with B16â€“B19. Minor spec/implementation drift â€” `settings_endpoints.md` documents HTTP 400 for validation failures. Recommend API Contracts owner updates spec to reflect 422 for Pydantic validation errors. Low priority.

**OBS-002 â€” B04 calculation discrepancy (ESCALATED TO DEF-005)**
`suggested_shares` returned 5.6003 for inputs entry_price: 100, stop_price: 90.53, risk_percent: 1.00. Manual calculation produces 5.6013. Head of Engineering reviewed `sizing_service.py` and could not reproduce the value through any consistent code path (Decimal quantisation, stamp duty adjustment, or floating point precision). Escalated to DEF-005. See Defects section.

**OBS-003 â€” "Use suggested shares" button styling unconfirmable**
F06: button present and functional. Styling (secondary/outline per spec) could not be confirmed visually against spec definition. Low priority â€” recommend Frontend Specifications & UX Documentation Owner clarifies colour values in spec.

**OBS-004 â€” Amber estimated cost styling unconfirmable**
F09: insufficient cash state correctly rendered. Amber styling on estimated cost could not be confirmed visually. Same recommendation as OBS-003.

**OBS-006 â€” Settings error message contains raw Pydantic field name**
F21/F22: inline error message reads "default_risk_percent must be greater than 0 and at most 100". The field name `default_risk_percent` is the raw Pydantic field name and is not user-friendly. Should read something like "Risk % must be greater than 0 and no more than 100". Low priority cosmetic fix â€” the error is functional and the constraint is clearly communicated. Assigned to Head of Engineering.
Every keystroke in the default_risk_percent field causes page re-render. Likely cause: settings save triggering on change rather than on explicit save action, causing re-fetch and re-render cycle. Low severity UX issue â€” not a spec violation but poor experience for a daily-use field. Assigned to Head of Engineering to investigate.

---

## Deferred Scenarios

One scenario remains deferred due to environment constraint:

| # | Reason for deferral |
|---|---------------------|
| F15 | Requires database access (BEGIN/ROLLBACK) â€” environment constraint. To be executed in re-verification pass. |

F16, F17, F18 have been executed and results recorded in this update (v1.1).

---

## Phase 1 Gate Check

- [x] Verification report completed and filed
- [x] Every non-deferred acceptance criterion has a recorded result
- [x] No Critical or High severity defects open
- [x] DEF-002 â€” resolved and re-verified âœ…
- [x] DEF-003 â€” resolved and re-verified âœ…
- [x] DEF-004 â€” resolved and re-verified âœ…
- [x] DEF-005 â€” closed, not a defect, B04 reclassified pass âœ…
- [x] DEF-006 â€” Low severity, remains open (session persistence of Risk %)
- [x] One known Low severity deviation logged (F20 helper text)
- [x] One new Low observation logged (OBS-006 â€” error message field name)
- [x] F16, F17, F18 executed and recorded
- [x] OBS-002 escalated to DEF-005, subsequently closed
- [x] Director of Quality sign-off granted at v1.1
- [ ] F15 to be completed in next available re-verification pass (environment constraint)
- [ ] DEF-006 to be resolved and re-verified before shipping closure

**Re-verification pass complete. One Low severity defect (DEF-006) and one deferred scenario (F15) remain outstanding before feature can be declared shipped.**

---

*Report filed: 2026-02-19 (v1.0)*
*Updated: 2026-02-19 (v1.1) â€” F16/F17/F18 executed, OBS-002 escalated to DEF-005, DEF-006 raised, resubmitted to Director of Quality. Sign-off granted.*
*Updated: 2026-02-20 (v1.2) â€” Re-verification pass complete. DEF-002, DEF-003, DEF-004 closed. DEF-005 closed as not a defect. B04 reclassified pass. OBS-006 added. DEF-006 and F15 remain outstanding.*
*QA Lead â€” 3.2 Position Sizing Calculator*

---

## Director of Quality Sign-Off

### v1.1 Sign-Off â€” 2026-02-19

```
Quality sign-off confirmed.
Verified by:   QA Lead
Reviewed by:   Director of Quality
Date:          2026-02-19
Verdict:       Pass with logged defects and observations

Open defects at sign-off:
  DEF-002 â€” Medium â€” INVALID_ENTRY_PRICE message not rendered
  DEF-003 â€” Medium â€” INVALID_STOP_PRICE message not rendered
  DEF-004 â€” Medium â€” Settings page silently swallows invalid save
  DEF-005 â€” Medium â€” suggested_shares calculation not fully traceable
  DEF-006 â€” Low    â€” Risk % resets to default after navigation

All open defects must be resolved, re-verified by QA Lead, and
recorded in the verification report before the feature is declared
shipped. F15 must be executed in the re-verification pass.
Feature is cleared for Phase 3. PMO Lead to coordinate shipping
closure actions once re-verification pass is complete.
```

### v1.2 Sign-Off â€” 2026-02-20

```
Quality sign-off confirmed â€” re-verification pass.
Verified by:   QA Lead
Reviewed by:   Director of Quality
Date:          2026-02-20
Verdict:       Re-verification pass complete

Resolved at this pass:
  DEF-002 â€” Medium â€” INVALID_ENTRY_PRICE message not rendered    âœ… Closed
  DEF-003 â€” Medium â€” INVALID_STOP_PRICE message not rendered     âœ… Closed
  DEF-004 â€” Medium â€” Settings page silently swallows invalid save âœ… Closed
  DEF-005 â€” Medium â€” Closed, not a defect                        âœ… Closed

Remaining before shipping closure:
  DEF-006 â€” Low â€” Risk % resets to default after navigation
  F15     â€” Deferred â€” Requires database access

Feature remains cleared for Phase 3. PMO Lead to coordinate
shipping closure once DEF-006 is resolved, re-verified, and
F15 is executed.
```
